<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>요일별 차량 배정표 - 고급 제약 조건</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      width: 100%;
      max-width: 800px;
    }
    #printableArea {
      background-color: white;
      padding: 2rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      background-color: white;
    }
    th, td {
      padding: 0.75rem;
      border: 1px solid #e5e7eb;
      text-align: center;
      font-size: 0.875rem;
    }
    th {
      background-color: #f9fafb;
      color: #374151;
      font-weight: 600;
    }
    td {
      color: #1d4ed8;
      font-weight: 500;
    }
    h1 {
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
      color: #1f2937;
    }
    h2 {
      font-size: 1.25rem;
      font-weight: 600;
      text-align: center;
      color: #4b5563;
      margin-bottom: 1.5rem;
    }
    .notes {
      margin-top: 2rem;
      padding: 1rem;
      background-color: #f9fafb;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      color: #4b5563;
    }
    .notes p {
      margin-bottom: 0.5rem;
    }
    .button-group {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin: 1.5rem auto 0;
    }
    button {
      background-color: #2563eb;
      color: white;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border-radius: 0.375rem;
      cursor: pointer;
      border: none;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #1d4ed8;
    }
    #pdfButton {
      background-color: #16a34a;
    }
    #pdfButton:hover {
      background-color: #15803d;
    }
    .overflow-container {
      width: 100%;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="printableArea">
      <h1 id="main-title">배차표</h1>
      <h2>(2025년 종로08번)</h2>
      <div class="overflow-container">
        <table id="assignmentTable"></table>
      </div>
      <div class="notes">
        <p><strong>주의)</strong> 오후 운행차량은 2시00분부터 운행하시길 부탁드립니다.</p>
        <p>차량 3614호는 근무자 근태확인 후 마지막 차량으로 배차가 들어갑니다.</p>
        <p>조별 팀장님들은 아침 오전 첫 차량을 확인하시어 맨 뒷에 후에 퇴근 바랍니다. (오전 첫차가 빠르게 주휴 할 수 있도록 배려 함)</p>
        <p>5월 1일부터는 첫차 06:00 막차 23:20입니다.</p>
      </div>
    </div>
    <div class="button-group">
      <button id="regenerateButton">다시 배정</button>
      <button id="pdfButton">PDF로 저장</button>
    </div>
  </div>

  <script>
    const days = ["월", "화", "수", "목", "금", "토", "일"];
    const carAssignmentsData = [
      { id: 1, label: "1", numbers: [5504, 5535, 6201, 3611, 3615, 5510, 3614] },
      { id: 2, label: "2", numbers: [5510, 5504, 3615, 6201, 3611, 3614, 5535] },
      { id: 3, label: "3", numbers: [6201, 3611, 5504, 5510, 5535, 3614, 3615] },
      { id: 4, label: "4", numbers: [3611, 6201, 5535, 3615, 5510, 5504, 3614] },
      { id: 5, label: "5", numbers: [3615, 5510, 3611, 5504, 6201, 3614, 5535] },
      { id: 6, label: "6", numbers: [5535, 3615, 5510, 3614, 5504, 3611, 6201] },
      { id: 7, label: "7", numbers: [3614, 3614, 3614, 3614, 3614, 3614, 3614], isFixed: true }
    ];

    const assignmentTable = document.getElementById("assignmentTable");
    const regenerateButton = document.getElementById("regenerateButton");
    const pdfButton = document.getElementById("pdfButton");
    const titleElement = document.querySelector("#printableArea h1");

    function generateValidAssignments() {
      const MAX_ATTEMPTS = 1000;

      for (let attempt = 0; attempt < MAX_ATTEMPTS; attempt++) {
        const resultGrid = Array(carAssignmentsData.length).fill(null).map(() => Array(days.length).fill(null));
        const dayUsedNumbers = days.map(() => new Set());
        let isSuccess = true;

        carAssignmentsData.forEach((car, carIndex) => {
          if (car.isFixed) {
            car.numbers.forEach((num, dayIndex) => {
              resultGrid[carIndex][dayIndex] = num;
              dayUsedNumbers[dayIndex].add(num);
            });
          }
        });

        const randomCarIndices = carAssignmentsData
          .map((_, index) => index)
          .filter(index => !carAssignmentsData[index].isFixed)
          .sort(() => Math.random() - 0.5);

        for (const carIndex of randomCarIndices) {
          if (!isSuccess) break;
          const car = carAssignmentsData[carIndex];
          let availableNumbersInRow = [...new Set(car.numbers)].sort(() => Math.random() - 0.5);

          for (let dayIndex = 0; dayIndex < days.length; dayIndex++) {
            const previousDayNumber = dayIndex > 0 ? resultGrid[carIndex][dayIndex - 1] : null;
            const candidates = availableNumbersInRow.filter(n =>
              !dayUsedNumbers[dayIndex].has(n) && n !== previousDayNumber
            );

            if (candidates.length === 0) {
              isSuccess = false;
              break;
            }

            const chosenNumber = candidates[Math.floor(Math.random() * candidates.length)];
            resultGrid[carIndex][dayIndex] = chosenNumber;
            dayUsedNumbers[dayIndex].add(chosenNumber);
            availableNumbersInRow = availableNumbersInRow.filter(n => n !== chosenNumber);
          }
        }

        if (isSuccess) return resultGrid;
      }

      return null;
    }

    function renderTable() {
      titleElement.textContent = "배차표";
      titleElement.style.color = '#1f2937';
      assignmentTable.innerHTML = '';

      const finalAssignments = generateValidAssignments();

      if (finalAssignments === null) {
        const errorRow = document.createElement('tr');
        const errorTd = document.createElement('td');
        errorTd.setAttribute('colspan', days.length + 1);
        errorTd.style.color = '#ef4444';
        errorTd.style.fontWeight = 'bold';
        errorTd.textContent = "배정표 생성 실패 (규칙이 복잡하여 실패할 수 있습니다. '다시 배정'을 눌러주세요)";
        errorRow.appendChild(errorTd);
        assignmentTable.appendChild(errorRow);
        return;
      }

      const headerRow = document.createElement('tr');
      const thTitle = document.createElement('th');
      thTitle.textContent = "차번";
      headerRow.appendChild(thTitle);
      days.forEach(day => {
        const th = document.createElement('th');
        th.textContent = day;
        headerRow.appendChild(th);
      });
      assignmentTable.appendChild(headerRow);

      finalAssignments.forEach((rowData, carIndex) => {
        const tr = document.createElement('tr');
        const th = document.createElement('th');
        th.textContent = carAssignmentsData[carIndex].label;
        th.style.color = '#111827';
        tr.appendChild(th);
        rowData.forEach(number => {
          const td = document.createElement('td');
          td.textContent = number;
          tr.appendChild(td);
        });
        assignmentTable.appendChild(tr);
      });
    }

    function generatePdf() {
      const { jsPDF } = window.jspdf;
      const printableArea = document.getElementById('printableArea');

      html2canvas(printableArea, { scale: 3 }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'pt',
          format: 'a4'
        });
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;
        const ratio = canvasWidth / canvasHeight;
        const width = pdfWidth - 40;
        const height = width / ratio;

        pdf.addImage(imgData, 'PNG', 20, 20, width, height);
        pdf.save("배차표.pdf");
      });
    }

    renderTable();
    regenerateButton.addEventListener('click', renderTable);
    pdfButton.addEventListener('click', generatePdf);
  </script>
</body>
</html>